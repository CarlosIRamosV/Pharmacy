---
import Layout from "../../../layouts/Layout.astro";
import NavbarManager from "../../../components/NavbarManager.astro";
---

<Layout title="Lista de productos">
  <NavbarManager />
  <h1>Lista de productos</h1>
  <ul>
    <li><a href="./new">Add a new product</a></li>
  </ul>

  <!-- Search form -->
  <form>
    <!-- Name -->
    <label for="name">Search by name</label>
    <input type="text" id="name" name="name" placeholder="Search by name" />

    <!-- Description -->
    <label for="description">Search by description</label>
    <input
      type="text"
      id="description"
      name="description"
      placeholder="Search by description"
    />

    <!-- Limit -->
    <label for="limit">Limit</label>
    <select id="limit" name="limit">
      <option value="10">10</option>
      <option value="20">20</option>
      <option value="50">50</option>
      <option value="100">100</option>
    </select>

    <!-- Pagination -->
    <label for="page">Page</label>
    <input type="number" id="page" name="page" value="1" />

    <!-- Min price -->
    <label for="min_price">Min price</label>
    <input
      type="number"
      id="min_price"
      name="min_price"
      placeholder="Min price"
    />

    <!-- Max price -->
    <label for="max_price">Max price</label>
    <input
      type="number"
      id="max_price"
      name="max_price"
      placeholder="Max price"
    />
  </form>

  <!-- Table -->
  <table
    class="w-full text-sm text-left rtl:text-right text-gray-500 dark:text-gray-400"
  >
    <thead
      class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400"
    >
      <tr>
        <th class="px-6 py-3">ID</th>
        <th class="px-6 py-3">Name</th>
        <th class="px-6 py-3">Description</th>
        <th class="px-6 py-3">Price</th>
        <th class="px-6 py-3">
          <span class="sr-only">Seleccionar</span>
        </th>
        <th class="px-6 py-3">
          <span class="sr-only">Editar</span>
        </th>
        <th class="px-6 py-3">
          <span class="sr-only">Eliminar</span>
        </th>
      </tr>
    </thead>
    <tbody id="products"></tbody>
  </table>
</Layout>

<script>
  let name = document.getElementById("name");
  let description = document.getElementById("description");
  let limit = document.getElementById("limit");
  let page = document.getElementById("page");
  let minPrice = document.getElementById("min_price");
  let maxPrice = document.getElementById("max_price");

  name.addEventListener("input", loadTable);

  description.addEventListener("input", loadTable);

  limit.addEventListener("change", loadTable);

  page.addEventListener("input", loadTable);

  minPrice.addEventListener("input", loadTable);

  maxPrice.addEventListener("input", loadTable);

  function loadTable() {
    if (
      minPrice.value &&
      maxPrice.value &&
      parseInt(minPrice.value) > parseInt(maxPrice.value)
    ) {
      alert("Min price must be lower than max price");
      return;
    }

    let url = "http://localhost/api/products/";
    let count = 0;

    if (name.value) {
      url += count > 0 ? "&" : "?";
      url += "name=" + name.value;
      count++;
    }

    if (description.value) {
      url += count > 0 ? "&" : "?";
      url += "description=" + description.value;
      count++;
    }

    if (minPrice.value) {
      url += count > 0 ? "&" : "?";
      url += "min_price=" + minPrice.value;
      count++;
    }

    if (maxPrice.value) {
      url += count > 0 ? "&" : "?";
      url += "max_price=" + maxPrice.value;
      count++;
    }

    if (limit.value) {
      url += count > 0 ? "&" : "?";
      url += "limit=" + limit.value;
      count++;
    }

    if (page.value) {
      url += count > 0 ? "&" : "?";
      url += "offset=" + (page.value - 1) * limit.value;
      count++;
    }

    fetch(url)
      .then((response) => response.json())
      .then(renderTable);
  }

  function renderTable(data) {
    let table = document.getElementById("products");
    table.innerHTML = "";
    data.forEach((product) => {
      let row = document.createElement("tr");
      row.className =
        "odd:bg-white odd:dark:bg-gray-900 even:bg-gray-50 even:dark:bg-gray-800 border-b dark:border-gray-700";
      row.innerHTML = `
        <td class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap dark:text-white">${product.id}</td>
        <td class="px-6 py-4">${product.name}</td>
        <td class="px-6 py-4">${product.description}</td>
        <td class="px-6 py-4">${product.price}</td>
        <td class="px-6 py-4">
          <a href="/products/${product.id}" class="font-medium text-blue-600 dark:text-blue-500 hover:underline">View</a>
        </td>
        <td class="px-6 py-4 text-right">
          <a href="./${product.id}/edit" class="font-medium text-blue-600 dark:text-blue-500 hover:underline">Edit</a>
        </td>
        <td class="px-6 py-4 text-right">
          <a href="./${product.id}/delete" class="font-medium text-blue-600 dark:text-blue-500 hover:underline">Delete</a>
        </td>
      `;
      table.appendChild(row);
    });
  }

  loadTable();
</script>
