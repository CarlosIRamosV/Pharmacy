---
import Layout from "../../../layouts/Layout.astro";
import SelectBranch from "../../../components/SelectBranch.astro";
---

<Layout title="Home">
  <h1>Lista de productos en stock</h1>
    <!-- Select the branch you want to see -->
  <SelectBranch/>

  <ul>
    <li><a href="/stocks/create">Create a new stock</a></li>
    </ul>

  <!-- Search for a product -->
  <label for="search">
    <input type="text" id="search" placeholder="Search for a product">
  </label>


    <!-- Table -->
    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>Product</th>
          <th>Product ID</th>
          <th>Quantity</th>
          <th>Edit</th>
          <th>Delete</th>
        </tr>
        </thead>
        <tbody id="stocks">
        </tbody>
    </table>
</Layout>

<script>
  if (sessionStorage.getItem('branch')) {
    loadTable(sessionStorage.getItem('branch'));
  }
    document.getElementById('branch').addEventListener('change', (event) => {
        loadTable(event.target.value);
    });


  document.getElementById('search').addEventListener('input', (event) => {
    fetch('http://localhost/api/stocks?branch_id=' + sessionStorage.getItem('branch') + '&product_name=' + event.target.value)
        .then(response => response.json())
        .then(renderTable);
    });

  function loadTable(branch_id) {
    fetch('http://localhost/api/stocks?branch_id=' + branch_id)
        .then(response => response.json())
        .then(renderTable);
    }

  function renderTable(data) {
    let table = document.getElementById('stocks');
    table.innerHTML = '';
    data.forEach(stock => {
      let row = document.createElement('tr');
      row.innerHTML = `
        <td>${stock.id}</td>
        <td>${stock.product_name}</td>
        <td>${stock.product_id}</td>
        <td>${stock.quantity}</td>
        <td><a href="/stocks/${stock.id}/edit">Edit</a></td>
        <td><a href="/stocks/${stock.id}/delete">Delete</a></td>
      `;
      table.appendChild(row);
    });
  }
</script>